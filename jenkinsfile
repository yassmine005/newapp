def dockerImageServer
def dockerImageClient

pipeline {
    agent any

    triggers {
        pollSCM('H/5 * * * *')
    }

    environment {
        DOCKERHUB_CREDENTIALS_ID = '12905163'

        IMAGE_NAME_SERVER = 'yassminemahmoud/mern-server'
        IMAGE_NAME_CLIENT = 'yassminemahmoud/mern-client'
    }

    stages {

        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Detect Changes') {
            steps {
                script {
                    echo "Vérification des changements..."

                    hasServerChanges = (
                        bat(
                            script: "git diff --name-only HEAD~1 HEAD | findstr /R \"^server/\"",
                            returnStatus: true
                        ) == 0
                    )

                    hasClientChanges = (
                        bat(
                            script: "git diff --name-only HEAD~1 HEAD | findstr /R \"^client/\"",
                            returnStatus: true
                        ) == 0
                    )

                    echo "➡ Changement Server : ${hasServerChanges}"
                    echo "➡ Changement Client : ${hasClientChanges}"
                }
            }
        }

        stage('Build Server Image') {
            when {
                expression { return hasServerChanges }
            }
            steps {
                dir('server') {
                    script {
                        dockerImageServer = docker.build("${IMAGE_NAME_SERVER}:latest")
                    }
                }
            }
        }

        stage('Build Client Image') {
            when {
                expression { return hasClientChanges }
            }
            steps {
                dir('client') {
                    script {
                        dockerImageClient = docker.build("${IMAGE_NAME_CLIENT}:latest")
                    }
                }
            }
        }

        stage('Scan Server Image') {
            when {
                expression { return hasServerChanges }
            }
            steps {
